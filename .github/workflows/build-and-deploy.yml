name: Build & deploy

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Install Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 16.x
    
    - name: Install NPM packages
      run: npm ci
      
    - name: Update Browser list
      run: npx browserslist --update-db

    - name: Run ESLint and save output
      id: eslint
      run: |
        npx eslint . --format json > eslint-output.json || true
        echo "::set-output name=lint_output::$(cat eslint-output.json)"
        echo "::set-output name=warning_count::$(jq '.[] | select(.errorCount > 0) | .warningCount' eslint-output.json | add)"

    - name: Display warning count
      run: |
        echo "Total lint warnings: ${{ steps.eslint.outputs.warning_count }}"
    
    - name: Build project
      run: CI=false npm run build

    # - name: Upload production-ready build files
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: production-files
    #     path: ./build
  
  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v2
      with:
        name: production-files
        path: ./build

    - name: Deploy to gh-pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        external_repository: gnpaone/gnpaone.github.io
        publish_dir: ./build
